#include <stdint.h>

#ifdef BARE_METAL
    #include "my_printf.h"
    #define print ee_printf

    // MMIO registers
    #define CYCLE_LO_ADDR   ((volatile uint32_t*)0x80000000)
    #define CYCLE_HI_ADDR   ((volatile uint32_t*)0x80000004)
    #define TICK_CNT_ADDR   ((volatile uint32_t*)0x60000000)
    #define HALT_ADDR       ((volatile uint32_t*)0x8FFFFFF0)
    #define HALT_DATA       ((uint32_t)0x000000AA)

    static inline void poke32(volatile uint32_t* addr, uint32_t data) {
        *addr = data;
    }
    static inline void core_halt(void) {
        poke32(HALT_ADDR, HALT_DATA);
    }
    static inline uint64_t barebones_clock(void) {
        uint32_t hi1, lo, hi2;
        do {
            hi1 = *CYCLE_HI_ADDR;
            lo  = *CYCLE_LO_ADDR;
            hi2 = *CYCLE_HI_ADDR;
        } while (hi1 != hi2);
        return ((uint64_t)hi2 << 32) | lo;
    }
#else
    #include <stdio.h>
    #define print printf

    // Stubs for PC
    static inline void poke32(volatile uint32_t* addr, uint32_t data) {
        (void)addr; (void)data;
    }
    static inline void core_halt(void) { }
    static inline uint64_t barebones_clock(void) { return 0; }
    #define TICK_CNT_ADDR ((volatile uint32_t*)0)
#endif

int main(void) {
    uint64_t start = barebones_clock();

    // We print the banner line by line to avoid size limits
    print("\n                                      @@@@@@@@@@@@@@@@@@@@@@@@                                      \n");
    print("                                @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                 \n");
    print("                             @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                             \n");
    print("                          @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                          \n");
    print("                       @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                       \n");
    print("                     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                     \n");
    print("                   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                    \n");
    print("                 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                             \n");
    print("                @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                              \n");
    print("              @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                             \n");
    print("                         @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@             \n");
    print("                            @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@            \n");
    print("                           @@@@@@@@@@@     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@           \n");
    print("          @@@@@@@@@@@@@@@@@@@@@@@@@            @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@          \n");
    print("         @@@@@@@@@@@@@@@@@@@@@@@@               @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@         \n");
    print("        @@@@@@@@@@@@@@@@@@@@@@@@                 @@@@@@@@@                                          \n");
    print("        @@@@@@@@@@@@@@@@@@@@@@@@                 @@@@@@@@                                           \n");
    print("                                                                                                    \n");
    print("@@@@@           @@@@@         @@@@@@@@@@@@@@@@         @@@@@@@@@@@@@@@@@           @@@@@@@@@@@@@@@@ \n");
    print("@@@@@@        @@@@@@@        @@@@@@@@@@@@@@@@@@        @@@@@@@@@@@@@@@@@@@        @@@@@@@@@@@@@@@@@@\n");
    print("@@@@@@@@     @@@@@@@@        @@@@@@@@@@@@@@@@@@@       @@@@@@@@@@@@@@@@@@@       @@@@@@@@@@@@@@@@@@@\n");
    print("@@@@@@@@@@ @@@@@@@@@@        @@@@          @@@@@       @@@@@         @@@@@       @@@@@          @@@@\n");
    print("@@@@@@@@@@@@@@@@@@@@@        @@@@          @@@@@       @@@@@         @@@@@       @@@@@@@@@@@@@@@@@@ \n");
    print("@@@@  @@@@@@@@@ @@@@@        @@@@@@@@@@@@@@@@@@@       @@@@@@@@@@@@@@@@@@@        @@@@@@@@@@@@@@@@@@\n");
    print("@@@@   @@@@@@   @@@@@        @@@@@@@@@@@@@@@@@@@       @@@@@@@@@@@@@@@@@@          @@@@@@@@@@@@@@@@@\n");
    print("@@@@     @@     @@@@@        @@@@@@@@@@@@@@@@@@@       @@@@@@@@@@@@@@@@          @@@@@          @@@@\n");
    print("@@@@            @@@@@        @@@@          @@@@@       @@@@@      @@@@@@@        @@@@@@@@@@@@@@@@@@@\n");
    print("@@@@            @@@@@        @@@@          @@@@@       @@@@@       @@@@@@@        @@@@@@@@@@@@@@@@@@\n");
    print("@@@@            @@@@@        @@@@          @@@@@       @@@@@         @@@@@          @@@@@@@@@@@@@@  \n");
    print("                                                                                                    \n");
    print("        @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@               @@@@@@@@@@@@@@@@@@@        \n");
    print("        @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@             @@@@@@@@@@@@@@@@@@@         \n");
    print("                         @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@       @@@@@@@@@@@@@@@@@@@@@@         \n");
    print("                            @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@          \n");
    print("                          @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@           \n");
    print("            @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@            \n");
    print("             @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@             \n");
    print("              @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                         \n");
    print("                @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                           \n");
    print("                 @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                          \n");
    print("                   @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                    \n");
    print("                     @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                     \n");
    print("                       @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                       \n");
    print("                          @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                          \n");
    print("                             @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                             \n");
    print("                                @@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@@                                 \n");
    print("                                     @@@@@@@@@@@@@@@@@@@@@@@@@                                      \n");

    // Done printing
    uint64_t end = barebones_clock();
    uint32_t ticks = (uint32_t)(end - start);

#ifdef BARE_METAL
    poke32(TICK_CNT_ADDR, ticks);
    print("\n[INFO] Banner printed in %u cycles.\n", ticks);
#else
    print("\n[INFO] Banner printed successfully.\n");
#endif

    core_halt();
    return 0;
}
